name: Deploy to Server via GHCR with Cloudflare Access SSH

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    env:
      SSH_HOST: ssh.distribuidauce.org
      SSH_USER: soportefing
      IMAGE_NAME: boiler-template-front-group-one

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install cloudflared
        run: |
          curl -LO https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Login to GHCR
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
        run: |
          echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin

      - name: Build and Push Docker image
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
        run: |
          docker build -t ghcr.io/$GHCR_USERNAME/$IMAGE_NAME:latest .
          docker push ghcr.io/$GHCR_USERNAME/$IMAGE_NAME:latest

      - name: Deploy on remote server
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          ssh -o "ProxyCommand=cloudflared access ssh --hostname $SSH_HOST" $SSH_USER@$SSH_HOST "
            echo \"$GHCR_TOKEN\" | docker login ghcr.io -u \"$GHCR_USERNAME\" --password-stdin &&
            docker pull ghcr.io/$GHCR_USERNAME/$IMAGE_NAME:latest &&
            docker stop mi-app || true &&
            docker rm mi-app || true &&
            docker run -d --name mi-app -p 80:80 ghcr.io/$GHCR_USERNAME/$IMAGE_NAME:latest &&
            echo 'ðŸš€ App desplegada correctamente'
          "
