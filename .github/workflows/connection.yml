name: Deploy to Remote Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: List files (debug)
        run: ls -la

      - name: Deploy via SSH (Cloudflare)
        shell: bash
        run: |
          echo "ðŸ“¡ Conectando al servidor..."
          ssh -tt -o "ProxyCommand=cloudflared access ssh --hostname ssh.distribuidauce.org" soportefing@ssh.distribuidauce.org << 'EOF'
          echo "âœ… ConexiÃ³n SSH exitosa"
          # Asegurar que el directorio exista y cambiar a Ã©l
          mkdir -p /home/soportefing/app && cd /home/soportefing/app

          # Borrar el proyecto anterior de forma segura
          if [ "$PWD" = "/home/soportefing/app" ]; then
            echo "ðŸ§¹ Limpiando el directorio /home/soportefing/app..."
            rm -rf ./*
            echo "âœ… Directorio limpiado."
          else
            echo "âŒ Error: No se pudo cambiar al directorio /home/soportefing/app. No se borrarÃ¡ nada."
            exit 1
          fi
          exit
          EOF

      - name: Subir archivos al servidor
        shell: bash
        run: |
          scp -o "ProxyCommand=cloudflared access ssh --hostname ssh.distribuidauce.org" -r ./* soportefing@ssh.distribuidauce.org:/home/soportefing/app/

      - name: Iniciar contenedor remoto
        shell: bash
        run: |
          ssh -tt -o "ProxyCommand=cloudflared access ssh --hostname ssh.distribuidauce.org" soportefing@ssh.distribuidauce.org << 'EOF'
          cd /home/soportefing/app
          docker build -t mi-app:latest .
          docker stop mi-app || true
          docker rm mi-app || true
          docker run -d --name mi-app -p 80:80 mi-app:latest
          echo "ðŸš€ AplicaciÃ³n desplegada exitosamente"
          exit
          EOF